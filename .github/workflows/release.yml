name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g. v0.1.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-linux:
    name: Build (Linux x86_64)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config libudev-dev libhidapi-dev libgl1-mesa-dev \
            libxrandr-dev libxcb-render0-dev libxi-dev libxcursor-dev \
            libxinerama-dev libx11-dev libatk1.0-dev libgtk-3-dev \
            libusb-1.0-0-dev libxdo-dev libfuse2

      - name: Install cargo-packager
        run: cargo install cargo-packager --locked

      - name: Build
        run: cargo build --release --target x86_64-unknown-linux-gnu

      - name: Package
        run: cargo packager --release --formats deb,appimage

      - name: Upload deb
        uses: actions/upload-artifact@v4
        with:
          name: linux-deb
          path: target/release/*.deb

      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage
          path: target/release/*.AppImage

      - name: Upload portable binary
        uses: actions/upload-artifact@v4
        with:
          name: linux-portable
          path: target/x86_64-unknown-linux-gnu/release/datavis-rs

  build-macos-aarch64:
    name: Build (macOS aarch64)
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: Install cargo-packager
        run: cargo install cargo-packager --locked

      - name: Build
        run: cargo build --release --target aarch64-apple-darwin

      - name: Package
        run: cargo packager --release --formats dmg

      - name: Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: macos-aarch64-dmg
          path: target/release/*.dmg

      - name: Upload portable binary
        uses: actions/upload-artifact@v4
        with:
          name: macos-aarch64-portable
          path: target/aarch64-apple-darwin/release/datavis-rs

  build-macos-x86_64:
    name: Build (macOS x86_64)
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin

      - name: Install cargo-packager
        run: cargo install cargo-packager --locked

      - name: Build
        run: cargo build --release --target x86_64-apple-darwin

      - name: Package
        run: cargo packager --release --formats dmg --target x86_64-apple-darwin

      - name: Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: macos-x86_64-dmg
          path: target/release/*.dmg

      - name: Upload portable binary
        uses: actions/upload-artifact@v4
        with:
          name: macos-x86_64-portable
          path: target/x86_64-apple-darwin/release/datavis-rs

  build-windows:
    name: Build (Windows x86_64)
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Install cargo-packager
        run: cargo install cargo-packager --locked

      - name: Build
        run: cargo build --release --target x86_64-pc-windows-msvc

      - name: Package
        run: cargo packager --release --formats nsis,wix

      - name: Upload MSI
        uses: actions/upload-artifact@v4
        with:
          name: windows-msi
          path: target/release/*.msi

      - name: Upload NSIS installer
        uses: actions/upload-artifact@v4
        with:
          name: windows-nsis
          path: target/release/*-setup.exe

      - name: Upload portable exe
        uses: actions/upload-artifact@v4
        with:
          name: windows-portable
          path: target/x86_64-pc-windows-msvc/release/datavis-rs.exe

  release:
    name: Create Release
    needs: [build-linux, build-macos-aarch64, build-macos-x86_64, build-windows]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release

          # Linux
          cp artifacts/linux-deb/*.deb release/ || true
          cp artifacts/linux-appimage/*.AppImage release/ || true
          cp artifacts/linux-portable/datavis-rs release/datavis-rs-linux-x86_64
          chmod +x release/datavis-rs-linux-x86_64

          # macOS aarch64
          cp artifacts/macos-aarch64-dmg/*.dmg release/ || true
          cp artifacts/macos-aarch64-portable/datavis-rs release/datavis-rs-macos-aarch64
          chmod +x release/datavis-rs-macos-aarch64

          # macOS x86_64
          cp artifacts/macos-x86_64-dmg/*.dmg release/ || true
          cp artifacts/macos-x86_64-portable/datavis-rs release/datavis-rs-macos-x86_64
          chmod +x release/datavis-rs-macos-x86_64

          # Windows
          cp artifacts/windows-msi/*.msi release/ || true
          cp artifacts/windows-nsis/*-setup.exe release/ || true
          cp artifacts/windows-portable/datavis-rs.exe release/datavis-rs-windows-x86_64.exe

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.version || github.ref_name }}
          name: ${{ inputs.version || github.ref_name }}
          generate_release_notes: true
          files: release/*
